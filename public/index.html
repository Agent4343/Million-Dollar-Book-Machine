<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Million Dollar Book Machine</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        /* Login */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .login-card {
            background: rgba(255,255,255,0.05);
            padding: 2rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h1 {
            background: linear-gradient(90deg, #00d4ff, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1rem;
        }
        .header h1 {
            background: linear-gradient(90deg, #00d4ff, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
        }

        /* Forms */
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }
        label { display: block; margin-bottom: 0.25rem; color: #888; font-size: 0.9rem; }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-danger { background: rgba(231,76,60,0.2); color: #e74c3c; }

        /* Cards */
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { color: #00d4ff; margin-bottom: 1rem; font-size: 1.2rem; }
        .card h3 { color: #888; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Pipeline View */
        .pipeline { display: flex; flex-direction: column; gap: 0.5rem; }
        .layer {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #333;
        }
        .layer.available { border-left-color: #00d4ff; }
        .layer.in-progress { border-left-color: #f39c12; }
        .layer.completed { border-left-color: #2ecc71; }
        .layer.locked { opacity: 0.5; }
        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .layer-name { font-weight: 600; }
        .layer-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }
        .agents { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .agent {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .agent:hover { background: rgba(0,212,255,0.2); }
        .agent.passed { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .agent.failed { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .agent.running { background: rgba(243,156,18,0.2); color: #f39c12; }

        /* Output Panel */
        .output-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .output-panel pre {
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            color: #00d4ff;
        }

        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tab {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
        }
        .tab.active { background: linear-gradient(90deg, #00d4ff, #7b2cbf); }

        /* Hidden */
        .hidden { display: none !important; }

        /* Stats */
        .stat { text-align: center; padding: 1rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #00d4ff; }
        .stat-label { font-size: 0.8rem; color: #888; }

        /* Progress Bar */
        .progress-container {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .progress-title { font-weight: 600; font-size: 1.1rem; }
        .progress-percent { color: #00d4ff; font-weight: 700; font-size: 1.2rem; }
        .progress-bar {
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #888;
        }

        /* Run Full Button */
        .btn-full-pipeline {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: #fff;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            margin-top: 1rem;
        }
        .btn-full-pipeline:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(46,204,113,0.3); }
        .btn-full-pipeline:disabled {
            background: rgba(255,255,255,0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Running State */
        .running-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-card">
                <h1>Million Dollar Book Machine</h1>
                <p style="color:#888;margin-bottom:2rem;">AI-Powered Book Development</p>
                <form id="loginForm">
                    <input type="password" id="password" placeholder="Enter password" required>
                    <button type="submit" class="btn btn-primary" style="width:100%">Sign In</button>
                </form>
                <p id="loginError" class="hidden" style="color:#e74c3c;margin-top:1rem;">Invalid password</p>
            </div>
        </div>

        <!-- Main App -->
        <div id="appContent" class="hidden">
            <div class="header">
                <h1>Million Dollar Book Machine</h1>
                <button class="btn btn-danger btn-small" onclick="logout()">Sign Out</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('projects')">Projects</div>
                <div class="tab" onclick="showTab('newProject')">New Project</div>
                <div class="tab" onclick="showTab('pipeline')">Pipeline</div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab">
                <div class="card">
                    <h2>Your Projects</h2>
                    <div id="projectsList"></div>
                </div>
            </div>

            <!-- New Project Tab -->
            <div id="newProjectTab" class="hidden">
                <div class="card">
                    <h2>Create New Book Project</h2>
                    <form id="newProjectForm">
                        <div class="grid-2">
                            <div>
                                <label>Book Title *</label>
                                <input type="text" id="projectTitle" required placeholder="Your book title">
                            </div>
                            <div>
                                <label>Genre *</label>
                                <select id="projectGenre" required>
                                    <option value="">Select genre</option>
                                    <option value="literary_fiction">Literary Fiction</option>
                                    <option value="thriller">Thriller</option>
                                    <option value="mystery">Mystery</option>
                                    <option value="romance">Romance</option>
                                    <option value="sci_fi">Science Fiction</option>
                                    <option value="fantasy">Fantasy</option>
                                    <option value="horror">Horror</option>
                                    <option value="memoir">Memoir</option>
                                    <option value="self_help">Self-Help</option>
                                    <option value="business">Business</option>
                                </select>
                            </div>
                        </div>
                        <label>Book Description / Vision</label>
                        <textarea id="projectDescription" rows="4" placeholder="Describe your book idea..."></textarea>
                        <div class="grid-2">
                            <div>
                                <label>Target Word Count</label>
                                <input type="number" id="projectWordCount" value="80000">
                            </div>
                            <div>
                                <label>Target Audience</label>
                                <input type="text" id="projectAudience" placeholder="e.g., Adults 25-45">
                            </div>
                        </div>
                        <label>Comparable Titles (comma separated)</label>
                        <input type="text" id="projectComps" placeholder="e.g., The Alchemist, Atomic Habits">
                        <label>Themes (comma separated)</label>
                        <input type="text" id="projectThemes" placeholder="e.g., redemption, identity, love">
                        <button type="submit" class="btn btn-primary">Create Project</button>
                    </form>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipelineTab" class="hidden">
                <div id="noProjectSelected" class="card">
                    <p style="text-align:center;color:#888;">Select a project from the Projects tab to view its pipeline</p>
                </div>
                <div id="pipelineView" class="hidden">
                    <!-- Progress Bar -->
                    <div class="progress-container">
                        <div class="progress-header">
                            <span class="progress-title" id="progressTitle">Book Development Progress</span>
                            <span class="progress-percent" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-details">
                            <span id="progressStatus">Ready to start</span>
                            <span id="progressAgents">0 / 0 agents completed</span>
                        </div>
                        <button class="btn btn-full-pipeline" id="runFullPipelineBtn" onclick="runFullPipeline()">
                            Run Full Pipeline
                        </button>
                    </div>

                    <div class="grid-3" style="margin-bottom:1rem;">
                        <div class="card stat">
                            <div class="stat-value" id="statLayers">0</div>
                            <div class="stat-label">Layers</div>
                        </div>
                        <div class="card stat">
                            <div class="stat-value" id="statAgents">0</div>
                            <div class="stat-label">Agents</div>
                        </div>
                        <div class="card stat">
                            <div class="stat-value" id="statCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <h2 id="pipelineProjectTitle">Pipeline</h2>
                            <div class="pipeline" id="pipelineLayers"></div>
                            <div style="margin-top:1rem;">
                                <button class="btn btn-primary btn-small" id="runNextBtn" onclick="runNextAgent()">Run Next Agent</button>
                                <button class="btn btn-secondary btn-small" id="runAvailableBtn" onclick="runAllAvailable()">Run All Available</button>
                            </div>
                        </div>
                        <div class="card">
                            <h2>Agent Output</h2>
                            <p id="selectedAgentName" style="color:#888;margin-bottom:0.5rem;">Select an agent to view output</p>
                            <div class="output-panel">
                                <pre id="agentOutput">No output yet</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let projectData = null;

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({password: document.getElementById('password').value})
            });
            if (res.ok) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                loadProjects();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        async function logout() {
            await fetch('/api/auth/logout', {method: 'POST', credentials: 'include'});
            location.reload();
        }

        async function checkAuth() {
            const res = await fetch('/api/auth/check', {credentials: 'include'});
            const data = await res.json();
            if (data.authenticated) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                loadProjects();
            }
        }

        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById('projectsTab').classList.add('hidden');
            document.getElementById('newProjectTab').classList.add('hidden');
            document.getElementById('pipelineTab').classList.add('hidden');
            document.getElementById(tab + 'Tab').classList.remove('hidden');
        }

        // Projects
        async function loadProjects() {
            const res = await fetch('/api/projects', {credentials: 'include'});
            const data = await res.json();
            const container = document.getElementById('projectsList');

            if (data.projects.length === 0) {
                container.innerHTML = '<p style="color:#888;">No projects yet. Create your first book!</p>';
            } else {
                container.innerHTML = data.projects.map(p => `
                    <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <div>
                            <strong>${p.title}</strong>
                            <span style="color:#888;margin-left:1rem;">${p.status}</span>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="selectProject('${p.project_id}')">Open</button>
                    </div>
                `).join('');
            }
        }

        async function selectProject(projectId) {
            currentProject = projectId;
            await loadProjectPipeline();
            showTab('pipeline');
        }

        async function loadProjectPipeline() {
            if (!currentProject) return;

            const res = await fetch(`/api/projects/${currentProject}`, {credentials: 'include'});
            projectData = await res.json();

            document.getElementById('noProjectSelected').classList.add('hidden');
            document.getElementById('pipelineView').classList.remove('hidden');
            document.getElementById('pipelineProjectTitle').textContent = projectData.title;

            // Stats
            const layers = Object.keys(projectData.layers).length;
            let agents = 0, completed = 0;
            Object.values(projectData.layers).forEach(l => {
                Object.values(l.agents).forEach(a => {
                    agents++;
                    if (a.status === 'passed') completed++;
                });
            });
            document.getElementById('statLayers').textContent = layers;
            document.getElementById('statAgents').textContent = agents;
            document.getElementById('statCompleted').textContent = completed;

            // Update progress bar
            const percent = agents > 0 ? Math.round((completed / agents) * 100) : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressAgents').textContent = `${completed} / ${agents} agents completed`;

            // Update progress status
            let status = 'Ready to start';
            if (completed === agents && agents > 0) {
                status = 'Pipeline complete!';
                document.getElementById('runFullPipelineBtn').textContent = 'Pipeline Complete';
                document.getElementById('runFullPipelineBtn').disabled = true;
            } else if (completed > 0) {
                const currentLayer = projectData.current_layer || 0;
                status = `Layer ${currentLayer} in progress`;
            }
            document.getElementById('progressStatus').textContent = status;

            // Render pipeline
            const container = document.getElementById('pipelineLayers');
            container.innerHTML = '';

            Object.entries(projectData.layers).sort((a,b) => a[0] - b[0]).forEach(([layerId, layer]) => {
                const div = document.createElement('div');
                div.className = `layer ${layer.status}`;
                div.innerHTML = `
                    <div class="layer-header">
                        <span class="layer-name">Layer ${layerId}: ${layer.name}</span>
                        <span class="layer-status">${layer.status}</span>
                    </div>
                    <div class="agents">
                        ${Object.entries(layer.agents).map(([aid, a]) => `
                            <span class="agent ${a.status}" onclick="viewAgent('${aid}')" title="${a.status}">${a.status === 'passed' ? '✓' : a.status === 'failed' ? '✗' : '○'} ${aid}</span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function viewAgent(agentId) {
            if (!currentProject) return;
            document.getElementById('selectedAgentName').textContent = agentId;

            const res = await fetch(`/api/projects/${currentProject}/agent/${agentId}/output`, {credentials: 'include'});
            const data = await res.json();

            if (data.output) {
                document.getElementById('agentOutput').textContent = JSON.stringify(data.output, null, 2);
            } else {
                document.getElementById('agentOutput').textContent = data.message || 'No output yet';
            }
        }

        async function runNextAgent() {
            if (!currentProject) return;

            const res = await fetch(`/api/projects/${currentProject}/available-agents`, {credentials: 'include'});
            const data = await res.json();

            if (data.available_agents.length > 0) {
                const agent = data.available_agents[0];
                await fetch(`/api/projects/${currentProject}/execute/${agent.id}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                await loadProjectPipeline();
                viewAgent(agent.id);
            } else {
                alert('No agents available to run');
            }
        }

        async function runAllAvailable() {
            if (!currentProject) return;

            const res = await fetch(`/api/projects/${currentProject}/available-agents`, {credentials: 'include'});
            const data = await res.json();

            for (const agent of data.available_agents) {
                await fetch(`/api/projects/${currentProject}/execute/${agent.id}`, {
                    method: 'POST',
                    credentials: 'include'
                });
            }
            await loadProjectPipeline();
        }

        let isRunningPipeline = false;

        async function runFullPipeline() {
            if (!currentProject || isRunningPipeline) return;

            isRunningPipeline = true;
            const btn = document.getElementById('runFullPipelineBtn');
            const nextBtn = document.getElementById('runNextBtn');
            const availBtn = document.getElementById('runAvailableBtn');

            btn.disabled = true;
            nextBtn.disabled = true;
            availBtn.disabled = true;
            btn.innerHTML = '<span class="running-indicator"></span>Running Pipeline...';

            try {
                let hasMore = true;
                let iterations = 0;
                const maxIterations = 100; // Safety limit

                while (hasMore && iterations < maxIterations) {
                    iterations++;

                    // Get available agents
                    const res = await fetch(`/api/projects/${currentProject}/available-agents`, {credentials: 'include'});
                    const data = await res.json();

                    if (data.available_agents.length === 0) {
                        hasMore = false;
                        break;
                    }

                    // Execute each available agent
                    for (const agent of data.available_agents) {
                        document.getElementById('progressStatus').textContent = `Running: ${agent.name}`;

                        const execRes = await fetch(`/api/projects/${currentProject}/execute/${agent.id}`, {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (!execRes.ok) {
                            console.error(`Failed to execute ${agent.id}`);
                        }

                        // Update progress after each agent
                        await loadProjectPipeline();
                        viewAgent(agent.id);
                    }
                }

                // Final update
                await loadProjectPipeline();

                if (iterations >= maxIterations) {
                    alert('Pipeline stopped: maximum iterations reached. Some agents may have failed.');
                }
            } catch (error) {
                console.error('Pipeline error:', error);
                alert('An error occurred during pipeline execution. Check the console for details.');
            } finally {
                isRunningPipeline = false;
                btn.innerHTML = 'Run Full Pipeline';
                btn.disabled = false;
                nextBtn.disabled = false;
                availBtn.disabled = false;
                await loadProjectPipeline();
            }
        }

        // New Project
        document.getElementById('newProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                title: document.getElementById('projectTitle').value,
                genre: document.getElementById('projectGenre').value,
                description: document.getElementById('projectDescription').value,
                target_word_count: parseInt(document.getElementById('projectWordCount').value),
                target_audience: document.getElementById('projectAudience').value,
                comparable_titles: document.getElementById('projectComps').value.split(',').map(s => s.trim()).filter(s => s),
                themes: document.getElementById('projectThemes').value.split(',').map(s => s.trim()).filter(s => s)
            };

            const res = await fetch('/api/projects', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(body)
            });

            if (res.ok) {
                const data = await res.json();
                currentProject = data.project_id;
                document.getElementById('newProjectForm').reset();
                await loadProjects();
                await loadProjectPipeline();
                showTab('pipeline');
            }
        });

        checkAuth();
    </script>
</body>
</html>
